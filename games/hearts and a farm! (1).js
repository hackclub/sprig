/*@title: hearts and a farm!
@author:
@tags: []
@addedOn: 2025-00-00
*/

const melody = tune `
240: A4/240 + F4/240 + D4/240,
240,
240: A4/240 + F4/240 + C5/240,
240,
240: B4/240 + G4/240 + F4/240,
240,
240: A4/240,
240: G4/240,
240: A4/240 + F4/240 + D4/240,
240,
240: C5/240 + A4/240 + F4/240,
240,
240: D5/240 + B4/240 + G4/240,
240,
240: A4/240,
240: G4/240,
240: A4/240 + F4/240 + D4/240,
240,
240: C5/240 + A4/240 + F4/240,
240,
240: B4/240 + G4/240 + F4/240,
240: A4/240,
240: G4/240,
240: A4/240,
240,
240: A4/240,
240,
240: A4/240,
240,
240: G4/240,
480`
const cointune = tune`
108.30324909747293: B5-108.30324909747293 + D5-108.30324909747293 + G5-108.30324909747293,
108.30324909747293: B5-108.30324909747293 + G5-108.30324909747293 + D5-108.30324909747293,
3249.097472924188`
const buy = tune`
86.95652173913044: G5~86.95652173913044,
86.95652173913044: B5~86.95652173913044,
2608.695652173913`
const music = tune`
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: D5~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: G4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: D5~297.029702970297,
297.029702970297: E5~297.029702970297,
297.029702970297: D5~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: A4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: D5~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: G4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: G4~297.029702970297,
297.029702970297: F4~297.029702970297,
297.029702970297: G4~297.029702970297,
297.029702970297: B4~297.029702970297,
297.029702970297: C5~297.029702970297`
const moving = tune`
56.49717514124294: C4/56.49717514124294,
1751.4124293785312`
const meow = tune`
103.44827586206897: G5^103.44827586206897,
103.44827586206897: A5^103.44827586206897,
103.44827586206897: B5^103.44827586206897,
103.44827586206897: B5^103.44827586206897,
103.44827586206897: A5^103.44827586206897,
103.44827586206897: A5^103.44827586206897,
2689.655172413793`
const win = tune`
157.06806282722513,
157.06806282722513: C4~157.06806282722513,
157.06806282722513: D4~157.06806282722513 + C4-157.06806282722513,
157.06806282722513: E4~157.06806282722513 + D4-157.06806282722513 + C4^157.06806282722513,
157.06806282722513: F4~157.06806282722513 + E4-157.06806282722513 + D4^157.06806282722513 + C4/157.06806282722513,
157.06806282722513: G4~157.06806282722513 + F4-157.06806282722513 + E4^157.06806282722513 + D4/157.06806282722513,
157.06806282722513: A4~157.06806282722513 + G4-157.06806282722513 + F4^157.06806282722513 + E4/157.06806282722513,
157.06806282722513: B4~157.06806282722513 + A4-157.06806282722513 + G4^157.06806282722513 + F4/157.06806282722513,
157.06806282722513: C5~157.06806282722513 + B4-157.06806282722513 + A4^157.06806282722513 + G4/157.06806282722513,
157.06806282722513: D5~157.06806282722513 + C5-157.06806282722513 + B4^157.06806282722513 + A4/157.06806282722513,
157.06806282722513: E5~157.06806282722513 + D5-157.06806282722513 + C5^157.06806282722513 + B4/157.06806282722513,
157.06806282722513: F5~157.06806282722513 + E5-157.06806282722513 + D5^157.06806282722513 + C5/157.06806282722513,
157.06806282722513: G5~157.06806282722513 + F5-157.06806282722513 + E5^157.06806282722513 + D5/157.06806282722513,
157.06806282722513: A5~157.06806282722513 + G5-157.06806282722513 + F5^157.06806282722513 + E5/157.06806282722513,
157.06806282722513: B5~157.06806282722513 + A5-157.06806282722513 + G5^157.06806282722513 + F5/157.06806282722513,
157.06806282722513: B5~157.06806282722513 + A5-157.06806282722513 + F5/157.06806282722513 + G5^157.06806282722513,
157.06806282722513: A5~157.06806282722513 + G5-157.06806282722513 + E5/157.06806282722513 + F5^157.06806282722513,
157.06806282722513: G5~157.06806282722513 + F5-157.06806282722513 + D5/157.06806282722513 + E5^157.06806282722513,
157.06806282722513: F5~157.06806282722513 + E5-157.06806282722513 + C5/157.06806282722513 + D5^157.06806282722513,
157.06806282722513: E5~157.06806282722513 + D5-157.06806282722513 + B4/157.06806282722513 + C5^157.06806282722513,
157.06806282722513: D5~157.06806282722513 + C5-157.06806282722513 + A4/157.06806282722513 + B4^157.06806282722513,
157.06806282722513: C5~157.06806282722513 + B4-157.06806282722513 + G4/157.06806282722513 + A4^157.06806282722513,
157.06806282722513: B4~157.06806282722513 + A4-157.06806282722513 + F4/157.06806282722513 + G4^157.06806282722513,
157.06806282722513: A4~157.06806282722513 + G4-157.06806282722513 + E4/157.06806282722513 + F4^157.06806282722513,
157.06806282722513: G4~157.06806282722513 + F4-157.06806282722513 + D4/157.06806282722513 + E4^157.06806282722513,
157.06806282722513: F4~157.06806282722513 + E4-157.06806282722513 + C4/157.06806282722513 + D4^157.06806282722513,
157.06806282722513: E4~157.06806282722513 + D4-157.06806282722513 + C4^157.06806282722513,
157.06806282722513: D4~157.06806282722513 + C4-157.06806282722513,
157.06806282722513: C4~157.06806282722513,
471.2041884816754`
const coin = "c"
const bblock = "b"
const player = "p";
const gblock = "u";
const ggblock = "v";
const gggblock = "w";
const dblock = "d";
const shopkeeper = "s"
const mat = "m"
const cat = "k"
const seed = "g"
const bonsai = "q"
const clear = "z"
const cover = "y"
const black = "n"
const fire = "r"
const firee = "a"
const fireee = "e"
const fireeee = "f"
const letters = "h"
const letterh = "i"
const lettero = "o"
const letterp = "j"
let bought = 0;
let coins = 0;




// Define sprites
setLegend(
  [player, bitmap`
................
.3333.....3333..
333333...333333.
3333333.3333333.
333333333333333.
33332C030C23333.
.3332C030C2333..
..33333333333...
...333383333....
....3333333.....
....0333330.....
....0.333.0.....
...00..3..00....
................
................
................`],
  [cat, bitmap`
............L..L
...........LLLLL
..........LL0L0L
LLLLLLLLL88LL3LL
LLLLLLLLLL888LL.
L.LLLLLLLL6L8...
L.LLLLLLLLLL....
L.LLLLLLLLLL....
..LLLLLLLLL.....
..LLLLLLLLL.....
..LLLLLLLLL.....
..LL.L.L2LL.....
..LL.L.L2LL.....
..LL.L.L.LL.....
..LL.L...LL.....
................`],
  [letters, bitmap`
................
..0000000000000.
.0..............
.0..............
.0..............
.0..............
.0..............
..000000000000..
..............0.
..............0.
..............0.
..............0.
..............0.
..............0.
..000000000000..
................`],
  [letterh, bitmap`
................
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.00000000000000.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
................`],
  [lettero, bitmap`
................
..000000000000..
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
..000000000000..
................`],
  [letterp, bitmap`
................
..000000000000..
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0............0.
.0000000000000..
.0..............
.0..............
.0..............
.0..............
.0..............
.0..............
................`],
  [fire, bitmap`
0000000000000000
5000000500000050
0005000000050000
0050500500505000
0005050005050000
0000505050500000
0000050505000000
0505005050005050
0000050505000000
0000505050500000
0005050005050000
0050500500505000
0005000000050000
5000000500000050
0000000000000000
0000000000000000`],
  [firee, bitmap`
0000000000000000
0008880008880000
0080008080008000
0800000800000800
0800000000000800
8000888088800080
8008080808080080
8008808080880080
8008080808080080
0800808080800800
0080080808008000
0008008080080000
0000800800800000
0000080008000000
0000008080000000
0000000800000000`],
  [fireee, bitmap`
0000000000000000
0000000300000000
0003000000030000
0000000300000000
0030030003003000
0000000000000000
0000003330000000
0303003030030300
0000003330000000
0000000000000000
0030030003003000
0000000300000000
0003000000030000
0000000300000000
0000000000000000
0000000000000000`],
  [fireeee, bitmap`
0000H000000H0000
0H000000000000H0
00H000H00H000H00
000H00000000H000
H000H0HHHH0H000H
00000H0000H00000
00H0H0H00H0H0H00
0000H000000H0000
0000H0H00H0H0000
00H0H00HH00H0H00
00000H0000H00000
H000H0HHHH0H000H
000H00000000H000
00H000H00H000H00
0H000000000000H0
0000H000000H0000`],
  [cover, bitmap`
44D4444D444444D4
4444444444D44444
4D444D4444444444
44444444444D44D4
444444444D444444
44D4D4444444D444
4444444444444444
444444D444D44444
4444444444444444
444D44444D4444D4
4D44444444444444
4444444444444444
444D44444D4D44D4
444444D444444444
4D444444444444D4
444444444D444444`],

  [bonsai, bitmap`
00000L000L000000
0000L3L0L3L00000
0000L33L33L00000
0000L33333L00000
00000L333L000000
00000L333L000000
000000L3L0000000
0000000L00000000
000LL00L00000000
00LDDL0L00000000
000LL0LL00000000
0000000L00000000
0000000L00000000
0000000L00000000
0000000L00000000
0000000L00000000`],
  [shopkeeper, bitmap`
.....00000......
.....00000......
.....00000......
.....00000......
.....00000......
.....00000......
.....00000......
.....00000......
...000000000....
....33...33.....
...3333.3333....
...320232023....
....3333333.....
.....33333......
.....03830......
....00.3.00.....`],
  [seed, bitmap`
......D.D.......
.......D........
......FFF.......
.....FFCFF......
.....FFCFF......
....FFFCFFF.....
....FCFCFCF.....
...FFCFCFCFF....
...FCFFCFFCF....
...FCFFCFFCF....
...FCFFCFFCF....
...FCFFCFFCF....
...FCFFCFFCF....
...FFCFFFCFF....
....FFCFCFF.....
.....FFFFF......`],
  [coin, bitmap`
................
................
................
................
.....6666.......
....666666......
...66336366.....
...66333366.....
...663333666....
...666336666....
....6666666.....
.....66666......
................
................
................
................`],
  [dblock, bitmap`
CCCC1CCCC1CCCC1C
CCCC1CCCC1CCCC1C
CCC1CCCCCC1CC1CC
CCC1CCCCCC1CC1CC
CCCC1CCCC1CCCC1C
CCCC1CCCC1CCCC1C
CCC1CCCCCC1CC1CC
CCC1CCCCCC1CC1CC
CCCC1CCCC1CCCC1C
CCCC1CCCC1CCCC1C
CCC1CCCCCC1CC1CC
CCC1CCCCCC1CC1CC
CCCC1CCCC1CCCC1C
CCCC1CCCC1CCCC1C
CCC1CCCCCC1CC1CC
CCC1CCCCCC1CC1CC`],
  [bblock, bitmap`
333C333C333C333C
333C333C333C333C
CCCCCCCCCCCCCCCC
3C333C333C333C33
3C333C333C333C33
CCCCCCCCCCCCCCCC
333C333C333C333C
333C333C333C333C
CCCCCCCCCCCCCCCC
3C333C333C333C33
3C333C333C333C33
CCCCCCCCCCCCCCCC
333C333C333C333C
333C333C333C333C
CCCCCCCCCCCCCCCC
3C333C333C333C33`],
  [gblock, bitmap`
444444444444D444
4444D44444444444
4444444444444444
4444444444D44444
4D44444444444444
4444444D44444D44
4444444444444444
4444D444444D4444
4444444444444444
D4444444444444D4
4444444444444444
4444D44444444444
44444444444D4444
4444444444444444
D44444444D4444D4
4444D44444444444`],
  [ggblock, bitmap`
4444444444444444
444D44444444D444
4444444444444744
44444444D4447674
4444444444444744
4444444444444444
444D444444444444
4444448444444444
44444868444D4444
44D4448444444444
4444444444444444
4444444444444444
44444444444444D4
44D444D444444444
4444444444444444
44444444444D4444`],
  [gggblock, bitmap`
4444444D4444444D
4D444D4444444444
4444444444444444
44D4444444444D44
444444444D444444
44444D4444444444
4D44444444444444
444D444444444D44
4444444D44444444
44444444444D4444
44D4444444444444
44444444D4444444
4444D44444444D44
4444444444D44444
4444444444444444
444D4444444D4444`],
  [clear, bitmap``],
  [black, bitmap`
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000
0000000000000000`],
  [mat, bitmap`
FFFFCCCCCCCCFFFF
CCCCFFFFFFFFCCCC
FFFFCCCCCCCCFFFF
CCCCFFFFFFFFCCCC
FFFFCCCCCCCCFFFF
FFFFFFFFFFFFFFFF
FFCCFCCFCCFCCFFF
FFCFFCFFCFFCFCFF
FFCFFCCFCCFCFCFF
FFFCFCFFCFFCFCFF
FFCCFCCFCCFCCFFF
FFFFFFFFFFFFFFFF
FFFFCCCCCCCCFFFF
CCCCFFFFFFFFCCCC
FFFFCCCCCCCCFFFF
CCCCFFFFFFFFCCCC`]);


function fireworks() {
  const playback = playTune(win, Infinity)
  addText("you win!!!", {
    x: 5,
    y: 6,
    color: color`2`
  })
  addText("ty for playing!<3", {
    x: 2,
    y: 7,
    color: color`2`
  })
  addText("took so long to make", {
    x: 0,
    y: 8,
    color: color`2`
  })
  currentMap = 1;
  setMap(levels[currentMap]);
}
let farm = 0;
const levels = [
  map`
wvuuvubuuu
wuuuwmbuuu
uwuuuwbbbb
uuuwuuuuwu
puuwuuuwuv
wuuuuddddd
uwuwwddddd
uvuuwddddd`, map`
nnnnnnqnrn
nfnnnnannn
nnennrnenn
rnnnqnnnnn
qnrnannnnq
annnnnnnna
nnnnnrnfnn
nfqnennqnr`,
];
//set solids//
setSolids([bblock, player, shopkeeper, seed, cat, bonsai]);
setMap(levels[farm]),
  //sound playing//
  // Pushable settings//
  setPushables({
    [player]: [seed]
  });

// Movement controls//
onInput("s", () => {
  getFirst(player).y += 1;
  playTune(moving)
  console.log("player", p.x, p.y)
});

onInput("a", () => {
  getFirst(player).x -= 1;
  playTune(moving)
  console.log("player", p.x, p.y)


});

onInput("d", () => {
  getFirst(player).x += 1;
  playTune(moving)
  console.log("player", p.x, p.y)


});

onInput("w", () => {
  getFirst(player).y -= 1;
  playTune(moving)
  console.log("player", p.x, p.y)


});

//spawn shopkeeper and replace missing grass block//
addSprite(7, 1, shopkeeper)
addSprite(0, 4, ggblock)
//shopkeeper stuff//
setInterval(() => {
  let shop = getFirst("s");
  if (!shop) return;

  const dir = Math.floor(Math.random() * 4);
  let nx = shop.x;
  let ny = shop.y;

  if (dir === 0) nx++;
  else if (dir === 1) nx--;
  else if (dir === 2) ny++;
  else if (dir === 3) ny--;
  const targets = getGrid().filter(s => s.x === nx && s.y === ny);

  const isBlocked = targets.some(s => s.type === "w" || s.type === "b");
  if (!isBlocked && nx >= 0 && nx < 20 && ny >= 0 && ny < 20) {
    shop.x = nx;
    shop.y = ny;
  }
}, 2000);
// player x,y and coin x,y//
let p = getFirst(player);
console.log(p.x, p.y);
addSprite(2, 6, coin);
addSprite(2, 6, cat);
let c = getFirst(coin);


//text go to shop//

addText("go to the shop", { x: 3, y: 7, color: color`0` })
let showing = false;
//AFTER INPUT//
// AFTER INPUT//
afterInput(() => {
  const p = getFirst(player);
  const c = getFirst(coin);
  const k = getFirst(cat);
  const g = getFirst(seed);
  if (bought === 1 && g && ((g.y === 5 && g.x >= 5 && g.x <= 9) || (g.x === 5 && g.y >= 5 && g.y <= 7))) { clearTile(g.x, g.y), addSprite(g.x, g.y, dblock), addSprite(g.x, g.y, bonsai), fireworks(); }



  // when at shop text logic//
  if (p.x === 5 && p.y === 1 && !showing) {
    clearText();
    addText("press I to interact", { x: 1, y: 7, color: color`0` });
    addText("with anything.", { x: 1, y: 9, color: color`0` });
    showing = true;
  }
  if (c && p.x === c.x && p.y === c.y) {
    coins = 1;

    c.remove();
    clearTile(0, 4);
    addSprite(0, 4, ggblock);
    clearText();
    console.log(coins);
    playTune(cointune)
  }

});


//shopping//
onInput("i", () => {
  if (p.x === 5 && p.y === 1 && coins === 1) { addSprite(2, 2, seed), clearText(), coins = 0, console.log(coins), playTune(buy), addText("seed bought!", { x: 4, y: 7, color: color`0` }), bought = 1 } else if (p.x === 5 && p.y === 1 && coins === 0)
    clearText(), playTune(melody), addText("you're broke", { x: 4, y: 3, color: color`0` }), addText("look for a coin?", { x: 4, y: 5, color: color`0` })
});
//coin touching detection//
//const playback = playTune(music, Infinity)//
onInput("i", () => {
  const p = getFirst(player);
  const k = getFirst(cat);
  if (p && k) {
    const dx = p.x - k.x;
    const dy = p.y - k.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance < 2) { playTune(meow), k.x = 3, k.y = 6 }
  }
})
addSprite(0, 0, seed);
clearTile(0, 0)
addSprite(0, 0, cover);
addSprite(6, 2, letters);
addSprite(7, 2, letterh);
addSprite(8, 2, lettero);
addSprite(9, 2, letterp);