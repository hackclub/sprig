/*
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

@title: Wolf and Eggs
@author: diantoniuksc
@tags: []
@addedOn: 2025-04-17
*/

const wolf = "w"
const eggSprite = "e"
const stoneSprite = "s"
const goldenEggSprite = "g"

const sfxCatch = tune`
200: C5^200,
200: G5~200,
6000`
const sfxGolden = tune`
100: C5^100,
100: E5~100,
100: G5^100,
2900`
const sfxHit = tune`
200: C4-200,
200: C4-200,
6000`

let fontColor = color`3`

const wolfDarkBitmap = bitmap`
......000000......
.....00000000.....
....0000000000....
...000000000000...
...000020200000...
...000000000000...
....0000000000....
..000000000000....
00000000000000....
00000000000000....
.....000000000....
.....000000000....
00000000000000....
..000000000000....
...00000000000....
.....00000000.....`

const wolfLightBitmap = bitmap`
......111111......
.....11111111.....
....1111111111....
...111111111111...
...000020200000...
...000000000000...
....0000000000....
..000000000000....
00000000000000....
00000000000000....
.....000000000....
.....000000000....
00000000000000....
..000000000000....
...00000000000....
.....00000000.....`

const eggDarkBitmap = bitmap`
................
................
................
................
.......00.......
.....000000.....
....00....00....
...00......00...
...00......00...
...00......00...
....00....00....
.....000000.....
.......00.......
................
................
................`

const eggLightBitmap = bitmap`
................
................
................
................
.......99.......
.....999999.....
....99....99....
...99......99...
...99......99...
...99......99...
....99....99....
.....999999.....
.......99.......
................
................
................`

const stoneDarkBitmap = bitmap`
................
................
................
................
.....000000.....
...00......00...
..0..00..00..0..
..0...0000...0..
..0....00....0..
..0...0000...0..
..0..0....0..0..
...00......00...
.....000000.....
................
................
................`

const stoneLightBitmap = bitmap`
................
................
................
................
.....LLLLLL.....
...LL......LL...
..L..LL..LL..L..
..L...LLLL...L..
..L....LL....L..
..L...LLLL...L..
..L..L....L..L..
...LL......LL...
.....LLLLLL.....
................
................
................`

const goldenEggDarkBitmap =  bitmap`
................
................
................
................
.......33.......
......3333......
.....33..33.....
.....3....3.....
....33....33....
....3......3....
....3......3....
....33....33....
.....33..33.....
......3333......
................
................`

const goldenEggLightBitmap = bitmap`
................
................
................
................
.......66.......
......6666......
.....66..66.....
.....6....6.....
....66....66....
....6......6....
....6......6....
....66....66....
.....66..66.....
......6666......
................
................`

let wolfBitmap = wolfDarkBitmap
let eggBitmap = eggDarkBitmap
let goldenEggBitmap = goldenEggDarkBitmap
let stoneBitmap = stoneDarkBitmap

setLegend(
  [wolf, wolfBitmap],
  [eggSprite, eggBitmap],
  [stoneSprite, stoneBitmap],
  [goldenEggSprite, goldenEggBitmap]
)

setSolids([])

let score = 0
let highScore = 0
let level = 1
let speed = 800
let gameInterval = null
let isGameActive = false

const eggPaths = [
  { x: 1, spawnY: 0, catchY: 6 },
  { x: 6, spawnY: 0, catchY: 6 }
]

let wolfPos = 0
let fallingItems = []

function placeWolf() {
  getAll(wolf).forEach(w => w.remove())
  const pos = eggPaths[wolfPos]
  addSprite(pos.x, pos.catchY, wolf)
}

setMap(map`
........
........
........
........
........
........
........`)
placeWolf()

onInput("a", () => { if (isGameActive) {wolfPos = 0; placeWolf() }})
onInput("d", () => { if (isGameActive) {wolfPos = 1; placeWolf() }})
onInput("s", () => { if (!isGameActive) { resetGame() }})
onInput("w", () => { applyTheme() })

let isDarkMode = true

function applyTheme() {
  isDarkMode = !isDarkMode
  if (isDarkMode){
    fontColor = color`3`
    wolfBitmap = wolfDarkBitmap
    eggBitmap = eggDarkBitmap
    stoneBitmap = stoneDarkBitmap
    goldenEggBitmap = goldenEggDarkBitmap
  }else{
    fontColor  =color`7`
    wolfBitmap = wolfLightBitmap
    eggBitmap = eggLightBitmap    
    stoneBitmap = stoneLightBitmap
    goldenEggBitmap = goldenEggLightBitmap
  }

  setLegend(
    [wolf, wolfBitmap],
    [eggSprite, eggBitmap],
    [stoneSprite, stoneBitmap],
    [goldenEggSprite, goldenEggBitmap]
  )  
}

function resetGame() {
  placeWolf()
  updateText() 
  startGameLoop()
}

function spawnItem() {
  const i = Math.floor(Math.random() * 2)
  const { x, spawnY } = eggPaths[i]
  const r = Math.random()
  let type = eggSprite
  if (r < 0.15) type = stoneSprite
  else if (r < 0.3) type = goldenEggSprite
  fallingItems.push({ path: i, x, y: spawnY, type })
}

function updateItems() {
  fallingItems.forEach(item => item.y += 1)

  for (let i = fallingItems.length - 1; i >= 0; i--) {
    const item = fallingItems[i]
    const end = eggPaths[item.path]
    const wolfSpot = eggPaths[wolfPos]

    if (item.y >= end.catchY) {
      if (item.x === wolfSpot.x && item.y === wolfSpot.catchY) {
        if (item.type === eggSprite) {
          playTune(sfxCatch)
          score += 1
        } else if (item.type === goldenEggSprite) {
          playTune(sfxGolden)
          score += 2
        } else if (item.type === stoneSprite) {
          playTune(sfxHit)
          endGame(`You caught a stone!\nGAME OVER\nScore: ${score} Lv: ${level}`)
          return
        }
      } else {
        if (item.type === eggSprite) {
          score = 0
        }
      }

      clearText()
      updateText()
      fallingItems.splice(i, 1)
      updateLevel()
    }
  }
}

function updateLevel(){
  if (score > 0 && score % 10 === 0){
    level++
    speed = Math.max(200, speed - 50)
    startGameLoop()
  }
}

function drawItems() {
  getAll(eggSprite).forEach(e => e.remove())
  getAll(stoneSprite).forEach(e => e.remove())
  getAll(goldenEggSprite).forEach(e => e.remove())

  fallingItems.forEach(f => addSprite(f.x, f.y, f.type))
}

function endGame(msg) {
  clearInterval(gameInterval)
  gameInterval = null
  clearText()
  addText(msg, { x: 1, y: 3, color: fontColor })

  score = 0
  level = 1
  speed = 600
  fallingItems = []
  drawItems()
  isGameActive = false
}

function updateText() {
  clearText()
  addText(`Score: ${score} Lv: ${level}`, {
    x: 1,
    y: 0,
    color: fontColor
  })
}

function startGameLoop() {
  if (gameInterval) clearInterval(gameInterval)

  isGameActive = true
  updateText()
  gameInterval = setInterval(() => {
    if (Math.random() < 0.7) spawnItem()
    updateItems()
    drawItems()
  }, speed)
}

startGameLoop()

afterInput(() => {
    //updateText()
})
