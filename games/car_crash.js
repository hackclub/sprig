const p= "p";
const c1= "1";
const c2= "2";
const c3= "3";

setLegend(
  [ p, bitmap`
...444444444....
......444.......
.....44444......
...044444440....
...044888440....
....4488844.....
....4488844.....
....4488844.....
....4488844.....
....4488844.....
...044444440....
...044444440....
....4444444.....
...044444440....
...044444440....
................`],


  [ c1, bitmap`
................
..55555555555...
..55555555555...
...055555550....
...055777550....
....5577755.....
....5577755.....
....5577755.....
....5577755.....
....5577755.....
...055555550....
...055555550....
....5555555.....
...055555550....
...055555550....
................`],


  [ c2, bitmap`
................
....1111111.....
...111111111....
......111.......
.....11111......
...011111110....
...011111110....
....1111111.....
....3333555.....
....3333555.....
....1111111.....
....1111111.....
....1111111.....
...011111110....
...011111110....
................`],


  [ c3, bitmap`
....7777777.....
...777777777....
...777777777....
...077777777....
...077555577....
....755555557...
....755555557...
..77577777775...
..77577777775...
..77577777775...
..77577777775...
....755555557...
....755555557...
...077777777....
...077777777....
................`]

);

setMap(map`
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...
...`);


let px=1;
let py=15;
let sc=0;
let spd=0.5;
let cars=[];
let isGameOver=false;

addSprite(px, py, p);

onInput("a", () =>{
  if (isGameOver) return;
  clearTile(px, py);
  px= Math.max(0, px - 1);
  addSprite(px, py, p);
});

onInput("d", ()=>{
  if (isGameOver) return;
  clearTile(px, py);
  px= Math.min(2, px + 1);
  addSprite(px, py, p);
});

function reset(){
  for (let car of cars) {
    clearTile(car.x, car.y);
  }
  cars= [];
  clearTile(px, py);
  px= 1;
  py= 15;
  addSprite(px, py, p);
  
  sc= 0;
  spd= 0.5;
  isGameOver= false;
  lastSpawnTime= 0;
  
  clearText();
  gameLoop();
}

onInput("w", ()=>{
  if (isGameOver){
    reset();
  }
});
function spawn(){
  let lane= Math.random() <0.4 ? px : Math.floor(Math.random()*3);
  const carType = Math.floor(Math.random() * 3) + 1;
  cars.push({ x: lane, y: 0, type: carType });
  addSprite(lane, 0, carType=== 1 ? c1 : (carType=== 2 ? c2 : c3));
}

function update(){
  for (let i = cars.length - 1; i >= 0; i--) {
    const car= cars[i];
    clearTile(car.x, car.y);
    car.y += 1;

    if (car.x=== px && car.y=== py){
      isGameOver = true;
      addText("Game Over!", { y: 4, color: color`3`});
      addText(`Score: ${sc}`, { y: 6, color: color`3`});
      addText("Press W to", { y: 8, color: color`3`});
      addText("start again", { y: 9, color: color`3`});
      return;
    }
    if (car.y >= height()){
      clearTile(car.x, car.y);
      cars.splice(i, 1);
      sc++;
      spd = Math.min(1.5, 0.5 + sc * 0.02);
    } else {
      addSprite(car.x, car.y, car.type=== 1 ? c1 : (car.type=== 2 ? c2 : c3));
    }
  }
}

let lastSpawnTime= 0;

function gameLoop(){
  if (isGameOver) return;
  
  clearText();
  addText(`Score: ${sc}`, { y: 0, color: color`3`});


  if (lastSpawnTime <= 0){
    if (Math.random() < 0.3) {
      spawn();
      if (Math.random() < 0.5) spawn();
    } else {
      spawn();
    }
    lastSpawnTime = Math.floor(8/ spd) + Math.random()*5;
  } else {
    lastSpawnTime--;
  }

  update();
  setTimeout(gameLoop,1000/ (10* spd));
}





gameLoop();
reset();