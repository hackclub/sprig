// !!!! If the game is too laggy I will change the map size (so that i halve the current resolution)

/*
@title: Precise Maze Game
@author: Malte Hansen
@tags: [top-down, maze]
@addedOn: 2025-10-12
*/

const playerPixel = "p"
const background = "b"
const spikePixel = "s"
const wallPixel = "w"
const goalPixel = "g"

setLegend(
  [ goalPixel, bitmap`
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555`],
  [ spikePixel, bitmap`
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333
3333333333333333`],
  [ wallPixel, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [ playerPixel, bitmap`
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666
6666666666666666` ],
  [ background, bitmap`
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222
2222222222222222`]
)

const levels = [
  map`
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................`,
  map`
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................
................................................................................................................................................................`
]

function summonSpike(x, y) {
  for(let i = 0; i < 8; i++) {
    addSprite(x + i, y + i, spikePixel)
    addSprite(x + 7 - i, y + i, spikePixel)
  }
}

function summonWall(x, y) {
  for(let i = 0; i < 8; i++) {
    for(let j = 0; j < 8; j++) {
      addSprite(x + i, y + j, wallPixel)
    }
  }
}

function summonGoal(x, y) {
  for(let i = 0; i < 8; i++) {
    for(let j = 0; j < 8; j++) {
      addSprite(x + i, y + j, goalPixel)
    }
  }
}

function summonPlayer(x, y) {
  for(let i = 0; i < 8; i++) {
    for(let j = 0; j < 8; j++) {
      addSprite(x + i, y + j, playerPixel)
    }
  }
}

/*
20x16 Matrix

0: Nothing
1: Spike
2: Wall
3: Player
4: Goal

*/

const smallestPossibleXValue = 0
const highestPossibleXValue = 159
const smallestPossibleYValue = 0
const highestPossibleYValue = 127

let grid = [
  [1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,1,1,1],
  [0,0,0,2,2,0,0,0,1,0,0,2,2,0,0,0,0,0,0,0],
  [0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,0],
  [0,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0],
  [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0],
  [0,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,0,0,0,0],
  [0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0],
  [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0],
  [0,0,1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0]
];


function initializeGame() { // For more levels: (int) level could be a param of initializeGame()
  alive = true
  clearText()
  
  setSolids([])
  setMap(levels[level])
  setBackground(background)

  for(let row = 0; row < grid.length; row++) {
    for(let col = 0; col < grid[row].length; col++) {
      if(grid[row][col] == 1) {
        summonSpike(col * 8, row * 8)
      } else if(grid[row][col] == 2) {
        summonWall(col * 8, row * 8)
      } else if(grid[row][col] == 3) {
        summonPlayer(col * 8, row * 8)
      } else if(grid[row][col] == 4) {
        summonGoal(col * 8, row * 8)
      }
    }
  }
}

onInput("w", () => {
  if(alive == true) {
    let playerPixels = getAll(playerPixel)

    for(let i = 0; i < playerPixels.length; i++) {
      playerPixels[i].y -= 1
    }
  }
})

onInput("a", () => {
  if(alive == true) {
    let playerPixels = getAll(playerPixel)
    
    for(let i = 0; i < playerPixels.length; i++) {
      playerPixels[i].x -= 1
    }
  }
})

onInput("s", () => {
  if(alive == true) {
    let playerPixels = getAll(playerPixel)
    
    for(let i = 0; i < playerPixels.length; i++) {
      playerPixels[i].y += 1
    }
  }
})

onInput("d", () => {
  if(alive == true) {
    let playerPixels = getAll(playerPixel)
    
    for(let i = 0; i < playerPixels.length; i++) {
      playerPixels[i].x += 1
    }
  }
})

onInput("i", () => {
  if(alive == false) {
    initializeGame()
  }
})

afterInput(() => {
  let playerPixels = getAll(playerPixel)
  let spikePixels = getAll(spikePixel)
  let goalPixels = getAll(goalPixel)

  for(p of playerPixels) {

    if(p.x < smallestPossibleXValue) {
      p.x = smallestPossibleXValue
    } 

    if(p.x > highestPossibleXValue) {
      p.x = highestPossibleXValue
    }

    if(p.y < smallestPossibleYValue) {
      p.y = smallestPossibleYValue
    } 

    if(p.x > highestPossibleYValue) {
      p.x = highestPossibleYValue
    }
    
    for(s of spikePixels) {
      if(p.x == s.x && p.y == s.y) {
        alive = false
        addText("You Died!", { x: 2, y: 2, color: color`0` })
        addText("Press i to respawn", { x: 2, y: 3, color: color`0` })
      }
    }

    for(g of goalPixels) {
      if(p.x == g.x && p.y == g.y && level < levels.length - 1) {
        level++
        initializeGame()
      }
    }
  }
})

let alive = true
let level = 0

initializeGame()
