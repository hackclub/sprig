/*
@title: 1_Little_Pixel
@description: Platformer game in which you start as a little pixel that can turn into a bird, fish, or turtle. :)
@author: Ansh
@tags: [platformer, shapeshifting, pixel, adventure, levels]
@addedOn: 2025-12-10
*/

const PLAYER = "p";
const WALL = "w";
const WATER = "a";
const LAVA = "l";
const CACTUS = "c";
const CANNON = "C";
const BULLET = "o";
const COIN = "$";
const GOAL = "g";
const SPIKE = "s";
const GATE = "G";

const RAINBOW_FRAMES = [
  bitmap`
................
................
......11111.....
.....1111111....
....111111111...
....111111111...
....111111111...
....111111111...
....111111111...
....111111111...
....111111111...
.....1111111....
......11111.....
................
................
................`,
  bitmap`
................
................
......33333.....
.....3333333....
....333333333...
....333333333...
....333333333...
....333333333...
....333333333...
....333333333...
....333333333...
.....3333333....
......33333.....
................
................
................`,
  bitmap`
................
................
......55555.....
.....5555555....
....555555555...
....555555555...
....555555555...
....555555555...
....555555555...
....555555555...
....555555555...
.....5555555....
......55555.....
................
................
................`,
  bitmap`
................
................
......77777.....
.....7777777....
....777777777...
....777777777...
....777777777...
....777777777...
....777777777...
....777777777...
....777777777...
.....7777777....
......77777.....
................
................
................`,
  bitmap`
................
................
......99999.....
.....9999999....
....999999999...
....999999999...
....999999999...
....999999999...
....999999999...
....999999999...
....999999999...
.....9999999....
......99999.....
................
................
................`
];

const BM_BIRD = bitmap`
................
................
......666.......
.....6...6......
....6.060.6.....
...6.......6....
...6.66666.6....
..666.....666...
.6...6...6...6..
.....6...6......
.....6...6......
......666.......
................
................
................
................`;

const BM_FISH = bitmap`
................
................
................
......777.......
....77...77.....
...7.......7....
..7.07...70.7...
.37.........73..
.37...777...73..
..7.........7...
...7.......7....
....7777777.....
................
................
................
................`;

const BM_TURTLE = bitmap`
................
................
................
......888.......
....8888888.....
...888888888....
..8.0888880.8...
..8.........8...
.88.........88..
.88...888...88..
..8.........8...
...888888888....
....8..8..8.....
................
................
................`;

const BM_SHELL = bitmap`
................
................
................
................
......888.......
....8888888.....
...888888888....
...888888888....
...888888888....
...888888888....
...888888888....
....8888888.....
................
................
................
................`;

const BM_WALL = bitmap`
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F
F0F0F0F0F0F0F0F0
0F0F0F0F0F0F0F0F`;

const BM_WATER = bitmap`
8888888888888888
8888888888888888
8888888888888888
7777777777777777
7778777877787777
7787778777877787
7877787778777877
8777877787778777
8888888888888888
8888888888888888
8888888888888888
8888888888888888
7777777777777777
8888888888888888
8888888888888888
8888888888888888`;

const BM_LAVA = bitmap`
4444444444444444
4343434343434343
3434343434343434
4343434343434343
4444444444444444
4444444444444444
4444444444444444
4343434343434343
3434343434343434
4343434343434343
4444444444444444
4444444444444444
4444444444444444
4343434343434343
3434343434343434
4343434343434343`;

const BM_CACTUS = bitmap`
................
................
................
......666.......
.....66666......
...666666666....
...666666666....
...666666666....
...6.66666.6....
...6.66666.6....
.....66666......
.....66666......
.....66666......
.....66666......
................
................`;

const BM_CANNON = bitmap`
................
................
................
.....000000.....
....01111110....
...0111111110...
..011111111110..
..011111111110..
..011111111110..
...0111111110...
....01111110....
.....000000.....
................
................
................
................`;

const BM_BULLET = bitmap`
................
................
................
................
......000.......
.....00000......
.....00000......
......000.......
................
................
................
................
................
................
................
................`;

const BM_COIN = bitmap`
................
................
................
......555.......
.....55555......
.....55155......
.....55555......
......555.......
................
................
................
................
................
................
................
................`;

const BM_GOAL = bitmap`
................
................
................
0003000.........
0333330.........
0333330.........
0003000.........
...3............
...3............
...3............
...3............
...3............
...3............
...3............
...3............
................`;

const COMMON_SPRITES = [
  [WALL, BM_WALL],
  [GATE, BM_WALL],
  [WATER, BM_WATER],
  [LAVA, BM_LAVA],
  [CACTUS, BM_CACTUS],
  [CANNON, BM_CANNON],
  [BULLET, BM_BULLET],
  [COIN, BM_COIN],
  [GOAL, BM_GOAL],
  [SPIKE, BM_CACTUS]
];

setLegend(
  [PLAYER, RAINBOW_FRAMES[0]],
  ...COMMON_SPRITES
);

const OBSTACLES = [WALL, GATE, CANNON, SPIKE, CACTUS];
setSolids([WALL, GATE, CANNON]);

const levels = [
  map`
................
................
................
................
................
................
................
.g......$.......
www....www......
...........$....
........www.....
...$...www......
..www...........
................
p...............
wwllllllllllllll`,

  map`
.g..............
ww..............
................
.......$........
......aaa.......
................
............$...
...........aaa..
................
...$............
..aaa...........
................
................
................
................
p...............
wwwwwwwwwwwwwwww`,

  map`
................
................
wwwwwwwwww......
waaaaaaaaa......
waawwwwwwwww....
waaw.......w....
waaw...$........
waaw..www.......
waawwwwwwwww....
waaaaaaaaaaw....
wwwwwwwwwwaw....
..g....$..aw....
wwwwwwwwwwww....
................
p...............
wwwwwwwwwwwwwwww`,

  map`
................
................
................
......C.........
......C.........
......C.........
......C.........
......C$........
......C.........
......C.........
......C.........
......C.........
......C$........
......C.........
p.....C........g
wwwwwwwwwwwwwwww`,

  map`
g...............
w.w.............
w.w.............
w.w.............
w.w.............
w.w............$
w.w...........ww
w.w..........www
w.w.....$.......
w.w....www......
w.w.............
w.w.............
w.w.............
w.w.............
p.w.............
wwwwwwwwwwwwwwww`,

  map`
.............www
...wwwwwwwwwww.g
...waaaaaaaaaa$.
...waawwwwwwww.w
...waaw........w
...waaw........w
...waaw........w
...waaw........w
...waawwwwwwwwww
...waaaaaaaaaaaa
.........wwwwwww
.......$ww.....w
......www......w
...............w
p..............w
wwwwwwwwwwwwwwww`,

  map`
................
................
................
...............g
................
................
................
................
.......$........
.GGGGGGGGGGGGGG.
.G............C.
.G............C.
.G............C.
.G$....p......C.
.GGGGGGGGGGGGGG.
wwwwwwwwwwwwwwww`,

  map`
g...............
www.............
...........$....
.......wwwwwww..
.......w........
...$...w........
..www..w...$....
.......w..www...
.......w........
.......C........
................
................
.......$........
...C.......C....
................
p...............
wwwwwwwwwwwwwwww`,

  map`
................
...g..$....$....
...w............
...w............
...wC...C...C...
...w............
...w.....$......
...w....www.....
...w..wwwwwww...
...w..w.....w...
...w..w.....w...
...w..w.....w...
...w..w.....w...
...w..w..$......
p..w..w.www.....
wwwwwwwwwwwwwwww`,

  map`
..w.............
w.w.............
w.w....$........
w.waaaaaaaaa....
w.waaaaaaaaaw...
w.waaww..wwaw...
w.waaw....waw...
w.waaw....waw...
w.waaw.$..waw...
w.waawwww.waw...
w.wwwwwwGGwaw...
w.........waw...
w....C....waw...
w.C........aw...
p.C..$.....aw.g.
wwwwwwwwwwwwwwww`
];

let levelIdx = 0;
let coins = 0;
let levelBlockedCount = 0;
let form = "square";
let isShelled = false;
let isDrifting = false;
let state = "INTRO";
let slideIdx = 0;
let totalCoinsInLevel = 0;
let gameStartTime = 0;
let lastInputTick = 0;

let vy = 0;
let canJump = false;
let ticks = 0;

const G_SQUARE = 0.4;
const J_SQUARE = -1.8;
const G_BIRD = 0.1;
const J_BIRD = -1.0;
const G_TURTLE = 0.5;
const J_TURTLE = -1.2;
const G_FISH_LAND = 0.5;
const G_FISH_WATER = 0;

const SLIDES = [
  [
    "1 Little Pixel",
    "",
    "A Minigame by Ansh",
    "",
    "Control your pixel.",
    "Learn to shapeshift.",
    "Collect ALL pixels",
    "to escape.",
    "",
    "PRESS A TO CONT."
  ],
  [
    "FORMS:",
    "",
    "J: SQUARE",
    "Run & Jump.",
    "",
    "I: BIRD",
    "Fly over gaps.",
    "Cannot swim.",
    "",
    "PRESS A TO CONT."
  ],
  [
    "FORMS:",
    "",
    "K: FISH",
    "Swim freely.",
    "No jump on land.",
    "",
    "L: TURTLE",
    "Block shots (S)",
    "Disable Cannons!",
    "",
    "PRESS A TO START"
  ]
];

function drawSlide() {
  clearText();
  const slides = SLIDES[slideIdx];
  for (let i = 0; i < slides.length; i++) {
    addText(slides[i], { x: 1, y: 1 + i, color: color`7` });
  }
}

function startLevel(idx) {
  if (idx >= levels.length) {
    state = "WIN";
    const totalTime = Math.floor((Date.now() - gameStartTime) / 1000);
    clearText();
    addText("YOU ESCAPED!", { x: 5, y: 5, color: color`3` });
    addText(`TIME: ${totalTime}s`, { x: 5, y: 7, color: color`7` });
    return;
  }
  levelIdx = idx;
  setMap(levels[levelIdx]);

  totalCoinsInLevel = tilesWith(COIN).length;
  coins = 0;

  vy = 0;
  form = "square";
  isShelled = false;
  isDrifting = false;
  levelBlockedCount = 0;
  updateSprite();
  updateHUD();
}

function updateHUD() {
  clearText();
  if (state === "PLAY") {
    const time = Math.floor((Date.now() - gameStartTime) / 1000);
    addText(`L:${levelIdx + 1} C:${coins}/${totalCoinsInLevel} T:${time}`, { x: 1, y: 0, color: color`7` });

    if (levelIdx === 0) {
      addText("WASD: Move", { x: 1, y: 2, color: color`5` });
    } else if (levelIdx === 1) {
      addText("PRESS I (BIRD)", { x: 1, y: 2, color: color`5` });
    } else if (levelIdx === 2) {
      addText("PRESS K (FISH)", { x: 1, y: 2, color: color`5` });
    } else if (levelIdx === 3) {
      addText("PRESS L (TURTLE)", { x: 1, y: 2, color: color`5` });
      addText("HOLD S TO BLOCK", { x: 1, y: 3, color: color`5` });
      addText(`BLOCKS: ${levelBlockedCount}/3`, { x: 1, y: 4, color: color`3` });
    } else if (levelIdx === 6) {
      addText("BLOCK 3 SHOTS", { x: 1, y: 2, color: color`5` });
      addText(`BLOCKS: ${levelBlockedCount}/3`, { x: 1, y: 3, color: color`3` });
    }
  } else if (state === "INTRO") {
    drawSlide();
  } else if (state === "PAUSED") {
    addText("PAUSED", { x: 5, y: 5, color: color`7` });
    addText("S: Resume", { x: 4, y: 7, color: color`5` });
  }
}

function updateSprite() {
  if (form === "square") {
  } else if (form === "bird") {
    setLegend([PLAYER, BM_BIRD], ...COMMON_SPRITES);
  } else if (form === "fish") {
    setLegend([PLAYER, BM_FISH], ...COMMON_SPRITES);
  } else if (form === "turtle") {
    setLegend([PLAYER, isShelled ? BM_SHELL : BM_TURTLE], ...COMMON_SPRITES);
  }
}

function die() {
  startLevel(levelIdx);
}

setInterval(() => {
  if (state !== "PLAY") return;

  // Timer Update
  if (ticks % 10 === 0) updateHUD(); // Update less frequently than every frame for perf, but enough for 1s

  const p = getFirst(PLAYER);
  if (!p) return;

  ticks++;

  if (form === "square") {
    setLegend([PLAYER, RAINBOW_FRAMES[Math.floor(ticks / 2) % 5]], ...COMMON_SPRITES);
  }

  let g = G_SQUARE;
  if (form === "bird") {
    g = G_BIRD;
    if (isDrifting) g = 0.05;
  } else if (form === "fish") {
    const inWater = getTile(p.x, p.y).some(t => t.type === WATER);
    if (inWater) g = G_FISH_WATER;
    else g = G_FISH_LAND;
  } else if (form === "turtle") {
    g = G_TURTLE;
  }

  if (form === "fish" && g === 0) {
    vy = 0;
    canJump = true;
  } else {
    const below = getTile(p.x, p.y + 1);
    const solidTypes = [...OBSTACLES];
    if (form !== "fish") solidTypes.push(WATER);

    const onGround = below.some(t => solidTypes.includes(t.type));

    if (onGround && vy >= 0) {
      vy = 0;
      canJump = true;
    } else {
      vy += g;
      const nextY = p.y + Math.sign(vy);
      if (nextY >= 0 && nextY <= 15) {
        const hit = getTile(p.x, nextY);
        let isHit = hit.some(t => OBSTACLES.includes(t.type));
        if (form !== "fish" && hit.some(t => t.type === WATER)) isHit = true;

        if (isHit) {
          vy = 0;
        } else {
          p.y = nextY;
        }
      } else if (nextY > 15) {
        die();
        return;
      }
    }
  }

  const t = getTile(p.x, p.y);

  const hitBullet = t.find(x => x.type === BULLET);
  if (hitBullet) {
    if (form === "turtle" && isShelled) {
      hitBullet.remove();
      levelBlockedCount++;
      updateHUD();
      if (levelBlockedCount >= 3) {
        getAll(CANNON).forEach(c => c.remove());
        getAll(GATE).forEach(g => g.remove());
      }
    } else {
      die();
    }
  }

  if (form === "turtle" && isShelled) {
    if (ticks - lastInputTick > 5) {
      isShelled = false;
      updateSprite();
    }
  }

  if (t.some(x => x.type === LAVA)) die();

  const c = t.find(x => x.type === COIN);
  if (c) {
    c.remove();
    coins++;
    updateHUD();
  }
  if (t.some(x => x.type === GOAL)) {
    if (coins >= totalCoinsInLevel) {
      startLevel(levelIdx + 1);
    }
  }

  if (ticks % 40 === 0) {
    getAll(CANNON).forEach(c => {
      if (c.x > 0) addSprite(c.x - 1, c.y, BULLET);
    });
  }
  if (ticks % 2 === 0) {
    getAll(BULLET).forEach(b => {
      const nextX = b.x - 1;
      if (nextX < 0) {
        b.remove();
        return;
      }
      const hit = getTile(nextX, b.y);
      if (hit.some(x => x.type === WALL || x.type === GATE)) {
        b.remove();
      } else {
        b.x = nextX;
        const pNow = getFirst(PLAYER);
        if (pNow && pNow.x === b.x && pNow.y === b.y) {
          if (form === "turtle" && isShelled) {
            b.remove();
            levelBlockedCount++;
            updateHUD();
            if (levelBlockedCount >= 3) {
              getAll(CANNON).forEach(c => c.remove());
              getAll(GATE).forEach(g => g.remove());
            }
          } else {
            die();
          }
        }
      }
    });
  }

}, 80);

function attemptMove(dx, dy) {
  const p = getFirst(PLAYER);
  if (!p) return;
  if (form === "turtle" && isShelled) return;
  if (form === "fish") {
    const inWater = getTile(p.x, p.y).some(t => t.type === WATER);
    if (inWater) {
    } else {
      if (Math.random() > 0.3) return;
    }
  }

  const tx = p.x + dx;
  const ty = p.y + dy;
  if (tx < 0 || tx > 15 || ty < 0 || ty > 15) return;

  const t = getTile(tx, ty);

  const solidTypes = [...OBSTACLES];
  if (form !== "fish") solidTypes.push(WATER);

  if (t.some(x => solidTypes.includes(x.type))) return;

  p.x = tx;
  p.y = ty;
}

onInput("a", () => {
  if (state === "INTRO") {
    slideIdx++;
    if (slideIdx >= SLIDES.length) {
      state = "PLAY";
      gameStartTime = Date.now();
      startLevel(0);
    }
    updateHUD();
    return;
  }
  if (state === "PLAY") attemptMove(-1, 0);
});

onInput("d", () => {
  if (state === "PLAY") attemptMove(1, 0);
});

onInput("w", () => {
  if (state !== "PLAY") return;

  if (form === "fish") {
    attemptMove(0, -1);
  } else if (canJump || form === "bird") {
    let j = J_SQUARE;
    if (form === "bird") j = J_BIRD;
    if (form === "turtle") j = J_TURTLE;
    vy = j;
    canJump = false;
  }
});

onInput("s", () => {
  if (state === "PAUSED") {
    state = "PLAY";
    updateHUD();
    return;
  }
  if (state !== "PLAY") return;

  if (form === "fish") {
    attemptMove(0, 1);
    return;
  }

  if (form === "square") {
    state = "PAUSED";
    updateHUD();
  } else if (form === "turtle") {
    isShelled = true;
    lastInputTick = ticks;
    updateSprite();
  } else if (form === "bird") {
    isDrifting = !isDrifting;
  }
});

function setForm(f) {
  if (state !== "PLAY") return;
  form = f;
  isShelled = false;
  isDrifting = false;
  updateSprite();
}

onInput("j", () => setForm("square"));
onInput("i", () => setForm("bird"));
onInput("k", () => setForm("fish"));
onInput("l", () => setForm("turtle"));

setMap(levels[0]);
updateHUD();