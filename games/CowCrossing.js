/*
@title: Cow Crossing
@description: Cow Crossing is a game where you help a cow avoid getting run over by cars while aiming to reach a score of 1000 points. Inspired by a local cow, this game adds an interesting twist by allowing players to get a speed boost from milk trucks that appear on the road. It's an engaging challenge as you navigate through roads with varying speeds of vehicles.
@author: GGGalang
@tags: []
@addedOn: 2024-06-24
First time? Check out the tutorial game:
https://sprig.hackclub.com/gallery/getting_started

*/

//sprites
const player = "p"
const car = "c"
const bcar = "b"
const road = "r"
const beef = "x"
const milk = "m"
const bmilk = "n"

//important vars
var playerMoves = []
var carProb = 9
var diff = 1000
var wave = 0

//tunes
const bgMusic = tune`
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4-260.8695652173913,
260.8695652173913: B5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913,
260.8695652173913: C4~260.8695652173913,
260.8695652173913: E5~260.8695652173913`
const crash = tune`
37.5: C4^37.5,
37.5: C4^37.5 + D4^37.5 + E4^37.5,
37.5: E4^37.5 + F4^37.5 + G4^37.5,
37.5: A4^37.5 + B4^37.5 + C5^37.5,
37.5: D5^37.5 + E5^37.5 + F5^37.5,
37.5: G5^37.5 + A5^37.5 + B5^37.5,
975`
const mCrash = tune`
37.5: C4-37.5 + D4~37.5 + E4~37.5 + F4~37.5,
37.5: D4-37.5 + E4-37.5 + F4~37.5 + G4~37.5 + A4~37.5,
37.5: F4-37.5 + A4~37.5 + B4~37.5,
37.5: G4-37.5 + C5~37.5 + D5~37.5,
37.5: A4-37.5 + B4-37.5 + D5~37.5 + E5~37.5 + F5~37.5,
37.5: C5-37.5 + F5~37.5 + G5~37.5 + A5~37.5 + B5~37.5,
37.5: D5-37.5 + E5-37.5 + F5-37.5 + G5-37.5 + A5-37.5,
937.5`
const win = tune`
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228 + E4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + A5-61.60164271047228 + C4~61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + G5-61.60164271047228 + D4~61.60164271047228 + C4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + E4^61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + C4~61.60164271047228 + D4^61.60164271047228 + E4^61.60164271047228,
61.60164271047228: G5-61.60164271047228 + A5-61.60164271047228 + C4~61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228,
61.60164271047228: A5-61.60164271047228 + D4~61.60164271047228 + E4^61.60164271047228`
const lose = tune`
65.21739130434783: B5-65.21739130434783,
65.21739130434783: A5-65.21739130434783,
65.21739130434783: A5-65.21739130434783,
65.21739130434783: G5-65.21739130434783,
65.21739130434783: G5-65.21739130434783 + F5-65.21739130434783,
65.21739130434783: F5-65.21739130434783,
65.21739130434783: F5-65.21739130434783 + E5-65.21739130434783,
65.21739130434783: E5-65.21739130434783 + D5-65.21739130434783,
65.21739130434783: D5-65.21739130434783 + C5-65.21739130434783 + B4-65.21739130434783,
65.21739130434783: B4-65.21739130434783 + A4-65.21739130434783,
65.21739130434783: G4-65.21739130434783 + F4-65.21739130434783,
65.21739130434783: F4-65.21739130434783 + E4-65.21739130434783,
65.21739130434783: E4-65.21739130434783,
65.21739130434783: E4-65.21739130434783 + D4-65.21739130434783,
65.21739130434783: D4-65.21739130434783,
65.21739130434783: D4-65.21739130434783 + C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783,
65.21739130434783: C4-65.21739130434783`
const womp = tune`
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541: E4-81.9672131147541,
81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
81.9672131147541: C4-81.9672131147541,
901.6393442622951`

const playback = playTune(bgMusic, Infinity);

setLegend(
  [ player, bitmap`
................
................
................
2222220022002727
2002220222022727
2002222222222727
2222222222222222
2200200220022777
2202200222022222
0222222222222222
222222....22..00
22..20....22..20
22..22....02..22
20..22....22..22
22..00....22..00
00........00....` ],
  [ car, bitmap`
................
................
................
................
................
................
................
.....9999999....
....79779779....
...7797797799...
..999999999999..
9999999999999999
9999999999999999
9990009990009999
...000...000....
...000...000....`],
  [ bcar, bitmap`
................
......66.6......
.....666666666..
.66..663666666..
.6666633636666..
..666333336666..
..666333336666..
...66633333666..
....663333366...
...7663333366...
..999663336699..
9999966333699999
9999996366999999
9990009666009999
...000...000....
...000...000....`],
  [ road, bitmap`
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
6666LL6666LL6666
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLL`],
  [ beef, bitmap`
................
................
................
................
................
...3333333333...
...3333333333...
2..3333333333..2
2223333333333222
2..3333333333..2
2..3333333333...
...3333333333...
................
................
................
................`],
  [ milk, bitmap`
................
....00220202....
....02202202....
....22222222....
..772777777722..
..772777777720..
..772777777720..
..772777777722..
..222200222222..
6220220020022223
6220222220220223
2222222022220022
0222220022222222
0200022222200022
22000......00022
..000......000..`],
  [ bmilk, bitmap`
.......6........
....00666202....
.66.026362666...
.666663336666...
..6633333333626.
..6633333333666.
..6663333333666.
..766633333666..
..266663333666..
6220666333666223
6220666633660223
2222266636660022
0222226666622222
0200022666200022
22000......00022
..000......000..`]
)

setSolids([])

let level = 0
const levels = [
  map`
.............
.............
.............
.............
.............
.............
.............
......p......`,
  map`
..........
..........
..........
..........
p.........`,
  map`
........
........
........
........
........
........
........
..mpc...`,
  map`
.......
.......
.......
.......
.......
.......
...x...
p..b...`
]

setMap(levels[level])
setBackground("r")

setPushables({
  [ player ]: []
})

onInput("s", () => {
  getFirst(player).y += 1
})

onInput("w", () => {
  getFirst(player).y -= 1
})

afterInput(() => {
  
})

function spawnCar(){
  var posY = Math.floor(Math.random()*5)
  var speed = Math.floor(Math.random()*2) + 1

  if (Math.floor(Math.random()*20) == 3){
    addSprite(9, posY, "m");
  } else {
    addSprite(9, posY, "c");
  }
  Object.defineProperty(getTile(9, posY)[0], "speed", {value: speed});
  console.log(speed)
}

function start(){
 var frame = setInterval(function(){

   //lose
  if(getAll("p").length == 0){
    playback.end()
    clearText();
    setMap(levels[3])
    playTune(lose)
    playTune(womp, 5)
    clearInterval(frame)
    addText("GAME OVER!", {
      x: 3,
      y: 3,
      color: color`2`
    });
    addText("Score: " + (wave*10), {
      x: 3,
      y: 4,
      color: color`2`
    });
    addText("womp womp ", {
      x: 3,
      y: 6,
      color: color`2`
    });
    return;
  }

  //win!
  if(wave == 100){
    clearText();
    playback.end()
    setMap(levels[2])
    clearInterval(frame)
    playTune(win)
    addText("YOU WIN!", {
      x: 2,
      y: 3,
      color: color`2`
    })
    addText("Score: " + (wave*10), {
      x: 3,
      y: 4,
      color: color`2`
    });
    return;
  }
  
  getAll("b").forEach((cars) => {
    clearTile(cars.x, cars.y)
  })

  getAll("n").forEach((xMilks) => {
    xMilks.remove()
  })
  
  let carChance = Math.floor(Math.random()*10);
  if (carChance <= (carProb-(1*(diff/1000)))){
    wave += 1
    spawnCar();
  }

  

  getAll("c").concat(getAll("m")).forEach((cars) => {
    //ensure cars dont clip out
    if(cars.x - cars.speed < 0){
      cars.x = 0;
    } else {
      cars.x -= cars.speed
    }

    //car collision logic
    if(cars.x == 0){
      let addX = cars.x
      let addY = cars.y
      if(cars.type == "m"){
        getTile(cars.x, cars.y).forEach((entity) => {
          if(entity.type == "p"){
            getAll("c").forEach((remove) => {
              addSprite(remove.x, remove.y, "b")
              remove.remove();
            });
          }
        })
        cars.remove()
        playTune(mCrash)
        addSprite(addX, addY, "n");
      } else {
        clearTile(cars.x, cars.y)
        playTune(crash)
        addSprite(addX, addY, "b");
      }
    }
  })

  if (diff>200){
    diff -= 10
    addText("Spawn Spd: " + diff, {
      x: 0,
      y: 0,
      color: color`2`
    })
  }
  console.log(diff)
  addText("Score: " + (wave*10), {
    x: 0,
    y: 1,
    color: color`2`
  });

  }, diff); 
}

if(level == 0){
  addText("WC Cow Crossing!", {
    x:3,
    y:3,
    color:color`2`
  })
  addText("Don't get hit!", {
    x:3,
    y:5,
    color:color`2`
  })
  addText("Exc. Milk trucks!", {
    x:3,
    y:6,
    color:color`2`
  })
  addText("They give boost.", {
    x:3,
    y:7,
    color:color`2`
  })
  addText("Move up to start!", {
    x:3,
    y:8,
    color:color`2`
  })

  addText("Try 1K Points!", {
    x:3,
    y:10,
    color:color`2`
  })
  var check = setInterval( function(){
    if(getFirst(player).y != 7){
      clearInterval(check)
      clearText()
      level += 1
      setMap(levels[level])
      start();
    }
  }, 200)
}
